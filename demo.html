<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login with Conditional CAPTCHA</title>
  <script src="blurcaptcha.js" defer></script>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
    }

    .login-container {
      width: 300px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .login-container input {
      width: calc(100% - 20px);
      margin: 10px 0;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #loginButton {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      color: #fff;
      background-color: #007bff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #captchaContainer {
      margin-top: 10px;
      display: none; /* CAPTCHA baÅŸlangÄ±Ã§ta gizli */
    }
  </style>
</head>
<body>
  <div class="login-container">
    <h3>GiriÅŸ Yap</h3>
    <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±" />
    <input type="password" id="password" placeholder="Åifre" />
    <div id="captchaContainer"></div>
    <button id="loginButton">GiriÅŸ Yap</button>
  </div>

  <script>
  let failedAttempts = 0; // BaÅŸarÄ±sÄ±z giriÅŸ sayacÄ±
  let wrongPasswordAfterCaptcha = 0; // CAPTCHA sonrasÄ± yanlÄ±ÅŸ ÅŸifre sayacÄ±

document.addEventListener("DOMContentLoaded", () => {
  const loginButton = document.getElementById("loginButton");
  const captchaContainer = document.getElementById("captchaContainer");

  // Sayfa yÃ¼klenirken timeout kontrolÃ¼
  checkPasswordTimeout();

  // CAPTCHA oluÅŸturma (BaÅŸlangÄ±Ã§ta gizli)
  let captchaInstance;

  const showCaptcha = () => {
    captchaContainer.style.display = "block"; // CAPTCHA gÃ¶rÃ¼nÃ¼r hale gelir
    captchaContainer.innerHTML = ""; // Ã–nceki CAPTCHA'yÄ± temizle
    captchaInstance = createCaptcha("captchaContainer", {
      digits: 4,
      blurLevel: 6,
      inputSize: 20,
      instructionText: "LÃ¼tfen aÅŸaÄŸÄ±daki sayÄ±larÄ± girin",
      activateButton: "loginButton", // GiriÅŸ butonu CAPTCHA sonrasÄ± aktif olur
      serverValidation: false, // Sunucu doÄŸrulamasÄ± iÃ§in true veya false
      serverUrl: "https://example.com/captcha-validate", // Sunucu doÄŸrulama URL'si
      onComplete: (digits) => {
        if (captchaInstance.settings.serverValidation) {
          // Sunucu doÄŸrulamasÄ±
          fetch(captchaInstance.settings.serverUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ digits }),
          })
            .then((response) => {
              if (!response.ok) throw new Error("CAPTCHA doÄŸrulama baÅŸarÄ±sÄ±z.");
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                alert("CAPTCHA doÄŸrulamasÄ± baÅŸarÄ±lÄ±!");
                loginButton.disabled = false; // GiriÅŸ butonunu aktif et
              } else {
                alert("CAPTCHA doÄŸrulama baÅŸarÄ±sÄ±z. Tekrar deneyin.");
              }
            })
            .catch((error) => {
              console.error("Hata:", error);
              alert("Bir hata oluÅŸtu. Tekrar deneyin.");
            });
        } else {
          // TarayÄ±cÄ± doÄŸrulamasÄ±
          alert("CAPTCHA doÄŸrulamasÄ± baÅŸarÄ±lÄ±!");
          loginButton.disabled = false; // GiriÅŸ butonunu aktif et
        }
      },
    });
  };

  // Åifre timeout kontrolÃ¼
  function checkPasswordTimeout() {
    const passwordTimeoutEnd = localStorage.getItem('password_timeout_end');
    if (passwordTimeoutEnd) {
      const remainingTime = parseInt(passwordTimeoutEnd, 10) - Date.now();
      if (remainingTime > 0) {
        showPasswordTimeoutScreen(remainingTime);
      } else {
        localStorage.removeItem('password_timeout_end');
        localStorage.removeItem('wrong_password_count');
      }
    }
  }

  // Åifre timeout ekranÄ±
  function showPasswordTimeoutScreen(remainingTime) {
    loginButton.disabled = true;
    loginButton.style.opacity = '0.5';
    loginButton.style.cursor = 'not-allowed';

    document.querySelector('.login-container').style.display = 'none';

    const timeoutDiv = document.createElement('div');
    timeoutDiv.id = 'passwordTimeoutScreen';
    timeoutDiv.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      color: #fff;
      padding: 30px 40px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(255, 107, 107, 0.4);
      text-align: center;
      z-index: 10000;
      min-width: 350px;
    `;

    const remainingMinutes = Math.ceil(remainingTime / 60000);
    const remainingSeconds = Math.ceil(remainingTime / 1000);

    timeoutDiv.innerHTML = `
      <div style="font-size: 70px; margin-bottom: 15px;">ğŸ”</div>
      <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">Hesap GeÃ§ici Kilitlendi</div>
      <div style="font-size: 14px; opacity: 0.95; margin-bottom: 20px;">Ã‡ok fazla yanlÄ±ÅŸ ÅŸifre denemesi</div>
      <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
        <div style="font-size: 16px; margin-bottom: 5px;">Kalan SÃ¼re:</div>
        <div id="passwordCountdown" style="font-size: 32px; font-weight: bold; font-family: monospace;">${formatTime(remainingSeconds)}</div>
      </div>
      <div style="font-size: 12px; opacity: 0.8;">LÃ¼tfen ${remainingMinutes} dakika sonra tekrar deneyin</div>
    `;

    document.body.appendChild(timeoutDiv);
    startPasswordCountdown(remainingTime);
  }

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function startPasswordCountdown(remainingTime) {
    const countdownElement = document.getElementById('passwordCountdown');
    if (!countdownElement) return;

    let timeLeft = Math.ceil(remainingTime / 1000);

    const interval = setInterval(() => {
      timeLeft--;

      if (timeLeft <= 0) {
        clearInterval(interval);
        localStorage.removeItem('password_timeout_end');
        localStorage.removeItem('wrong_password_count');
        location.reload();
      } else {
        countdownElement.textContent = formatTime(timeLeft);
      }
    }, 1000);
  }

  // Login butonu tÄ±klama olayÄ±
  loginButton.addEventListener("click", () => {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    if (captchaInstance && captchaInstance.settings.serverValidation && captchaContainer.style.display === "block") {
      // CAPTCHA Ã§Ã¶zÃ¼lmeden giriÅŸ yapÄ±lamaz
      alert("LÃ¼tfen CAPTCHA doÄŸrulamasÄ±nÄ± tamamlayÄ±n.");
      return;
    }

    if (username === "admin" && password === "12345") {
      // âœ… BAÅARILI GÄ°RÄ°Å
      alert("BaÅŸarÄ±yla giriÅŸ yaptÄ±nÄ±z!");
      localStorage.removeItem('wrong_password_count');
      localStorage.removeItem('captcha_last_success');
      failedAttempts = 0;
      wrongPasswordAfterCaptcha = 0;
    } else {
      // âŒ YANLIÅ ÅÄ°FRE
      failedAttempts++;

      // CAPTCHA baÅŸarÄ±yla Ã§Ã¶zÃ¼ldÃ¼ mÃ¼ kontrol et
      const lastCaptchaSuccess = localStorage.getItem('captcha_last_success');
      const captchaWasSolved = lastCaptchaSuccess && (Date.now() - parseInt(lastCaptchaSuccess, 10)) < 60000; // Son 1 dakika iÃ§inde

      if (captchaWasSolved) {
        // CAPTCHA Ã§Ã¶zÃ¼ldÃ¼ ama ÅŸifre yanlÄ±ÅŸ
        wrongPasswordAfterCaptcha++;
        localStorage.setItem('wrong_password_count', wrongPasswordAfterCaptcha.toString());

        console.warn(`âš ï¸ CAPTCHA Ã§Ã¶zÃ¼ldÃ¼ ama yanlÄ±ÅŸ ÅŸifre: ${wrongPasswordAfterCaptcha}/4`);

        if (wrongPasswordAfterCaptcha >= 4) {
          // 4 kere CAPTCHA Ã§Ã¶zÃ¼p yanlÄ±ÅŸ ÅŸifre girdi - ÅÃœPHELÄ°!
          const timeoutDuration = 3 * 60 * 1000; // 3 dakika
          const timeoutEnd = Date.now() + timeoutDuration;
          localStorage.setItem('password_timeout_end', timeoutEnd.toString());

          alert("âš ï¸ ÅÃ¼pheli aktivite tespit edildi!\n\nCAPTCHA'yÄ± 4 kere Ã§Ã¶zdÃ¼nÃ¼z ama ÅŸifre hep yanlÄ±ÅŸ.\n\n3 dakika sÃ¼reyle hesap kilitlendi.");
          setTimeout(() => location.reload(), 2000);
          return;
        } else {
          alert(`KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±. (${wrongPasswordAfterCaptcha}/4 yanlÄ±ÅŸ ÅŸifre)`);
          // CAPTCHA'yÄ± yenile
          captchaContainer.innerHTML = "";
          captchaContainer.style.display = "none";
          showCaptcha();
        }
      } else {
        // Normal hatalÄ± giriÅŸ
        if (failedAttempts >= 2) {
          alert("2 hatalÄ± giriÅŸ yaptÄ±nÄ±z. CAPTCHA doÄŸrulamasÄ± gerekiyor.");
          showCaptcha();
        } else {
          alert("KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±. Tekrar deneyin.");
        }
      }
    }
  });
});

  </script>
</body>
</html>
