<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BlurCaptcha - Standalone Test</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .demo-wrapper {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 1200px;
    }

    .login-container {
      width: 350px;
      padding: 30px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .login-container h3 {
      margin: 0 0 20px 0;
      text-align: center;
      color: #333;
      font-size: 24px;
    }

    .demo-label {
      display: inline-block;
      padding: 4px 12px;
      background: #667eea;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .login-container input[type="text"],
    .login-container input[type="password"] {
      width: 100%;
      margin: 10px 0;
      padding: 12px 16px;
      font-size: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: border-color 0.3s;
    }

    .login-container input[type="text"]:focus,
    .login-container input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .login-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #captchaContainer1,
    #captchaContainer2 {
      margin-top: 15px;
    }

    .info-box {
      margin-top: 15px;
      padding: 12px;
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      border-radius: 4px;
      font-size: 13px;
      color: #555;
    }

    .info-box strong {
      color: #667eea;
    }

    .status-indicator {
      margin-top: 10px;
      padding: 8px;
      background: #fff3cd;
      border-radius: 6px;
      font-size: 12px;
      color: #856404;
      text-align: center;
      display: none;
    }

    .status-indicator.show {
      display: block;
    }

    .status-indicator.success {
      background: #d4edda;
      color: #155724;
    }

    .status-indicator.error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="demo-wrapper">
    <!-- Demo 1: Otomatik Hatalı Giriş Tracking -->
    <div class="login-container">
      <span class="demo-label">DEMO 1 - Otomatik Tracking</span>
      <h3>Giriş Yap</h3>

      <div class="info-box">
        <strong>Bilgi:</strong> 2 hatalı giriş sonrası CAPTCHA otomatik devreye girer.<br>
        <strong>Test için:</strong> admin / 12345
      </div>

      <input type="text" id="username1" placeholder="Kullanıcı Adı" />
      <input type="password" id="password1" placeholder="Şifre" />

      <div id="captchaContainer1"></div>
      <div id="status1" class="status-indicator"></div>

      <button id="loginButton1" class="login-button">Giriş Yap</button>
    </div>

    <!-- Demo 2: Her Zaman Aktif CAPTCHA -->
    <div class="login-container">
      <span class="demo-label">DEMO 2 - Her Zaman Aktif</span>
      <h3>Güvenli Giriş</h3>

      <div class="info-box">
        <strong>Bilgi:</strong> CAPTCHA her zaman görünür ve zorunludur.<br>
        <strong>Test için:</strong> user / password123
      </div>

      <input type="text" id="username2" placeholder="Kullanıcı Adı" />
      <input type="password" id="password2" placeholder="Şifre" />

      <div id="captchaContainer2"></div>
      <div id="status2" class="status-indicator"></div>

      <button id="loginButton2" class="login-button" disabled>Giriş Yap</button>
    </div>
  </div>

  <!-- BlurCaptcha Library (Embedded) -->
  <script>
class Captcha {
  constructor(containerId, options = {}) {
    const defaultSettings = {
      digits: 4,
      blurLevel: 6,
      digitSize: 40,
      inputSize: 20,
      borderColor: '#007bff',
      textColor: '#000',
      instructionText: 'Lütfen aşağıdaki sayıları girin',
      securityMode: 'client',
      serverUrl: '/api/captcha',
      trackFailedAttempts: true,
      failureThreshold: 2,
      triggerElement: null,
      autoShow: false,
      ariaLabel: 'CAPTCHA Doğrulaması',
      enableKeyboardNav: true,
      onComplete: () => {},
      onFailureThresholdReached: () => {},
      onValidationSuccess: () => {},
      onValidationFailed: () => {},
      activateButton: null,
      debugMode: false,
    };

    this.settings = { ...defaultSettings, ...options };
    this.container = document.getElementById(containerId);

    if (!this.container) {
      throw new Error(`Container with ID "${containerId}" not found.`);
    }

    this.digits = [];
    this.captchaToken = null;
    this.failedAttempts = 0;
    this.firstInteractionComplete = false;
    this.isVisible = this.settings.autoShow;
    this.currentInputIndex = 0;

    if (!this.settings.autoShow) {
      this.container.style.display = 'none';
    }

    this.init();

    if (this.settings.trackFailedAttempts && this.settings.triggerElement) {
      this.setupFailureTracking();
    }
  }

  log(message, data = null) {
    if (this.settings.debugMode) {
      console.log(`[BlurCaptcha] ${message}`, data || '');
    }
  }

  async init() {
    if (this.settings.securityMode === 'server') {
      await this.fetchCaptchaFromServer();
    } else {
      this.digits = Array.from({ length: this.settings.digits }, () => Math.floor(Math.random() * 10));
      this.log('Client-side CAPTCHA oluşturuldu', this.digits);
    }

    this.renderCaptcha();
  }

  async fetchCaptchaFromServer() {
    try {
      this.log('Sunucudan CAPTCHA alınıyor...');
      const response = await fetch(`${this.settings.serverUrl}/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
      });

      if (!response.ok) {
        throw new Error('CAPTCHA oluşturulamadı');
      }

      const data = await response.json();
      this.captchaToken = data.token;
      this.digits = data.digits || [];
      this.log('Sunucudan CAPTCHA alındı', { token: this.captchaToken });
    } catch (error) {
      this.log('Sunucu hatası, client-side CAPTCHA kullanılıyor', error);
      this.digits = Array.from({ length: this.settings.digits }, () => Math.floor(Math.random() * 10));
    }
  }

  renderCaptcha() {
    this.container.innerHTML = `
      <div class="captcha-container"
           role="region"
           aria-label="${this.settings.ariaLabel}"
           style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 10px;">
        <div class="instruction"
             id="captcha-instruction-${this.container.id}"
             style="font-size: 14px; color: #555; text-align: center;"
             aria-live="polite">
          ${this.settings.instructionText}
        </div>
        <div class="captcha"
             role="presentation"
             style="display: flex; gap: 5px;"></div>
        <div class="input-row"
             role="group"
             aria-labelledby="captcha-instruction-${this.container.id}"
             style="display: flex; gap: 5px; margin-top: 5px;"></div>
        <div class="overlay"
             id="captchaOverlay-${this.container.id}"
             aria-live="assertive"
             style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 10;">
          <div class="checkmark" style="font-size: 50px; color: #28a745;" role="img" aria-label="Başarılı">✔</div>
        </div>
      </div>
    `;

    const captcha = this.container.querySelector('.captcha');
    const inputRow = this.container.querySelector('.input-row');

    this.digits.forEach((digit, index) => {
      const randomRotation = Math.floor(Math.random() * 41 - 20);
      const digitElement = document.createElement('div');
      digitElement.textContent = digit;
      digitElement.setAttribute('aria-hidden', 'true');
      digitElement.style.width = `${this.settings.digitSize}px`;
      digitElement.style.height = `${this.settings.digitSize}px`;
      digitElement.style.fontSize = `${this.settings.digitSize * 0.6}px`;
      digitElement.style.textAlign = 'center';
      digitElement.style.lineHeight = `${this.settings.digitSize}px`;
      digitElement.style.border = `1px solid ${this.settings.borderColor}`;
      digitElement.style.borderRadius = '5px';
      digitElement.style.backgroundColor = '#f8f9fa';
      digitElement.style.color = this.settings.textColor;
      digitElement.style.filter = index === 0 ? 'none' : `blur(${this.settings.blurLevel}px)`;
      digitElement.style.transform = `rotate(${randomRotation}deg)`;
      digitElement.style.transition = 'all 0.3s ease';

      const inputElement = document.createElement('input');
      inputElement.type = 'text';
      inputElement.inputMode = 'numeric';
      inputElement.pattern = '[0-9]';
      inputElement.maxLength = 1;
      inputElement.disabled = true;
      inputElement.setAttribute('aria-label', `Rakam ${index + 1}`);
      inputElement.setAttribute('aria-describedby', `captcha-instruction-${this.container.id}`);
      inputElement.style.width = `${this.settings.inputSize}px`;
      inputElement.style.height = `${this.settings.inputSize}px`;
      inputElement.style.fontSize = `${this.settings.inputSize * 0.6}px`;
      inputElement.style.textAlign = 'center';
      inputElement.style.border = `1px solid ${this.settings.borderColor}`;
      inputElement.style.borderRadius = '5px';
      inputElement.style.backgroundColor = index === 0 ? '#fff' : '#f8f9fa';

      inputElement.addEventListener('input', (e) => this.handleInput(e, index, digitElement, inputRow, captcha));
      inputElement.addEventListener('click', () => this.handleClick(inputRow));

      if (this.settings.enableKeyboardNav) {
        inputElement.addEventListener('keydown', (e) => this.handleKeyDown(e, index, inputRow));
      }

      captcha.appendChild(digitElement);
      inputRow.appendChild(inputElement);
    });

    this.container.addEventListener('mouseenter', () => {
      if (!this.firstInteractionComplete) {
        const firstInput = inputRow.querySelector('input');
        if (firstInput) {
          firstInput.disabled = false;
          this.firstInteractionComplete = true;
          this.log('İlk etkileşim tamamlandı');
        }
      }
    });
  }

  handleInput(event, index, digitElement, inputRow, captcha) {
    const inputElement = event.target;
    const inputValue = inputElement.value;

    if (!/^[0-9]$/.test(inputValue)) {
      inputElement.value = '';
      return;
    }

    if (inputValue === digitElement.textContent) {
      this.log(`Doğru rakam girişi: ${index + 1}/${this.digits.length}`);

      digitElement.style.filter = 'none';
      digitElement.style.transform = 'rotate(0deg)';
      inputElement.disabled = true;
      inputElement.setAttribute('aria-label', `Rakam ${index + 1} - Doğru`);

      if (index < this.digits.length - 1) {
        const nextInput = inputRow.children[index + 1];
        const nextDigit = captcha.children[index + 1];
        nextInput.disabled = false;
        nextInput.focus();
        nextDigit.style.filter = 'none';
        this.currentInputIndex = index + 1;
      } else {
        this.validateCaptcha();
      }

      if (this.settings.activateButton && index === this.digits.length - 1) {
        const button = document.getElementById(this.settings.activateButton);
        if (button) {
          button.disabled = false;
          this.log('Buton aktifleştirildi');
        }
      }
    } else {
      inputElement.value = '';
      inputElement.setAttribute('aria-label', `Rakam ${index + 1} - Hatalı giriş`);
    }
  }

  handleClick(inputRow) {
    if (!this.firstInteractionComplete) {
      this.firstInteractionComplete = true;
      const firstInput = inputRow.querySelector('input');
      if (firstInput) {
        firstInput.disabled = false;
        this.log('İlk tıklama ile aktifleştirildi');
      }
    }
  }

  handleKeyDown(event, index, inputRow) {
    const key = event.key;

    if (key === 'Backspace' && index > 0 && !event.target.value) {
      event.preventDefault();
      const prevInput = inputRow.children[index - 1];
      if (prevInput && !prevInput.disabled) {
        prevInput.focus();
        prevInput.value = '';
      }
    }

    if (key === 'ArrowLeft' && index > 0) {
      event.preventDefault();
      const prevInput = inputRow.children[index - 1];
      if (prevInput && !prevInput.disabled) {
        prevInput.focus();
      }
    }

    if (key === 'ArrowRight' && index < this.digits.length - 1) {
      event.preventDefault();
      const nextInput = inputRow.children[index + 1];
      if (nextInput && !nextInput.disabled) {
        nextInput.focus();
      }
    }
  }

  async validateCaptcha() {
    this.log('CAPTCHA doğrulanıyor...');

    if (this.settings.securityMode === 'server') {
      await this.validateWithServer();
    } else {
      this.showSuccessOverlay();
      this.settings.onComplete(this.digits);
      this.settings.onValidationSuccess();
    }
  }

  async validateWithServer() {
    try {
      this.log('Sunucu doğrulaması yapılıyor...', { token: this.captchaToken });

      const response = await fetch(`${this.settings.serverUrl}/validate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          token: this.captchaToken,
          digits: this.digits
        }),
      });

      if (!response.ok) {
        throw new Error('CAPTCHA validation failed.');
      }

      const data = await response.json();

      if (data.success) {
        this.log('Sunucu doğrulaması başarılı');
        this.showSuccessOverlay();
        this.settings.onComplete(this.digits);
        this.settings.onValidationSuccess();

        if (this.settings.trackFailedAttempts) {
          this.failedAttempts = 0;
        }
      } else {
        this.log('Sunucu doğrulaması başarısız');
        this.settings.onValidationFailed();
        alert('CAPTCHA doğrulama başarısız. Tekrar deneyin.');
        this.reset();
      }
    } catch (error) {
      this.log('Sunucu doğrulama hatası', error);
      this.settings.onValidationFailed();
      alert('Bir hata oluştu. Tekrar deneyin.');
      this.reset();
    }
  }

  showSuccessOverlay() {
    const overlay = document.getElementById(`captchaOverlay-${this.container.id}`);
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-label', 'CAPTCHA doğrulaması başarılı');

    setTimeout(() => {
      overlay.style.display = 'none';
      this.hide();
    }, 1500);
  }

  setupFailureTracking() {
    const triggerEl = document.getElementById(this.settings.triggerElement);

    if (!triggerEl) {
      console.warn(`[BlurCaptcha] Trigger element "${this.settings.triggerElement}" not found.`);
      return;
    }

    this.log('Hatalı giriş tracking kuruldu', {
      threshold: this.settings.failureThreshold,
      trigger: this.settings.triggerElement
    });

    this.originalTriggerHandler = null;
  }

  recordFailure() {
    if (!this.settings.trackFailedAttempts) return;

    this.failedAttempts++;
    this.log(`Hatalı giriş kaydedildi: ${this.failedAttempts}/${this.settings.failureThreshold}`);

    if (this.failedAttempts >= this.settings.failureThreshold) {
      this.log('Threshold aşıldı, CAPTCHA gösteriliyor');
      this.show();
      this.settings.onFailureThresholdReached();
    }
  }

  recordSuccess() {
    if (!this.settings.trackFailedAttempts) return;

    this.failedAttempts = 0;
    this.log('Başarılı giriş, sayaç sıfırlandı');
  }

  show() {
    this.isVisible = true;
    this.container.style.display = 'block';
    this.log('CAPTCHA gösterildi');

    setTimeout(() => {
      const firstInput = this.container.querySelector('input');
      if (firstInput && !firstInput.disabled) {
        firstInput.focus();
      }
    }, 100);
  }

  hide() {
    this.isVisible = false;
    this.container.style.display = 'none';
    this.log('CAPTCHA gizlendi');
  }

  reset() {
    this.log('CAPTCHA sıfırlanıyor...');
    this.currentInputIndex = 0;
    this.firstInteractionComplete = false;
    this.init();
  }

  isCompleted() {
    const inputs = this.container.querySelectorAll('input');
    return Array.from(inputs).every(input => input.disabled && input.value);
  }

  getFailedAttempts() {
    return this.failedAttempts;
  }

  destroy() {
    this.log('CAPTCHA destroy ediliyor');
    this.container.innerHTML = '';
    this.container.style.display = 'none';
  }
}

function createCaptcha(containerId, options) {
  return new Captcha(containerId, options);
}
  </script>

  <!-- Demo Script -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const username1 = document.getElementById("username1");
      const password1 = document.getElementById("password1");
      const loginButton1 = document.getElementById("loginButton1");
      const status1 = document.getElementById("status1");

      const captcha1 = createCaptcha("captchaContainer1", {
        digits: 4,
        blurLevel: 6,
        inputSize: 20,
        securityMode: 'client',
        autoShow: false,
        trackFailedAttempts: true,
        failureThreshold: 2,
        debugMode: true,
        instructionText: "Güvenlik doğrulaması: Aşağıdaki sayıları girin",

        onFailureThresholdReached: () => {
          showStatus(status1, "2 hatalı giriş! CAPTCHA devreye girdi.", "error");
        },

        onValidationSuccess: () => {
          showStatus(status1, "CAPTCHA doğrulandı! Giriş yapılabilir.", "success");
          loginButton1.disabled = false;
        },
      });

      loginButton1.addEventListener("click", () => {
        const user = username1.value.trim();
        const pass = password1.value.trim();

        if (!user || !pass) {
          showStatus(status1, "Lütfen tüm alanları doldurun.", "error");
          return;
        }

        if (captcha1.isVisible && !captcha1.isCompleted()) {
          showStatus(status1, "Lütfen CAPTCHA doğrulamasını tamamlayın.", "error");
          return;
        }

        if (user === "admin" && pass === "12345") {
          showStatus(status1, "✓ Başarıyla giriş yaptınız!", "success");
          captcha1.recordSuccess();

          setTimeout(() => {
            username1.value = "";
            password1.value = "";
            captcha1.hide();
            loginButton1.disabled = false;
            status1.classList.remove("show");
          }, 2000);
        } else {
          showStatus(status1, `✗ Hatalı giriş (${captcha1.getFailedAttempts() + 1}/${captcha1.settings.failureThreshold})`, "error");
          captcha1.recordFailure();

          if (captcha1.isVisible) {
            loginButton1.disabled = true;
          }
        }
      });

      const username2 = document.getElementById("username2");
      const password2 = document.getElementById("password2");
      const loginButton2 = document.getElementById("loginButton2");
      const status2 = document.getElementById("status2");

      const captcha2 = createCaptcha("captchaContainer2", {
        digits: 5,
        blurLevel: 7,
        inputSize: 22,
        digitSize: 45,
        securityMode: 'client',
        autoShow: true,
        trackFailedAttempts: false,
        debugMode: true,
        instructionText: "Güvenlik için aşağıdaki sayıları girin",
        borderColor: '#764ba2',

        onValidationSuccess: () => {
          showStatus(status2, "CAPTCHA doğrulandı!", "success");
          loginButton2.disabled = false;
        },

        onComplete: (digits) => {
          console.log('CAPTCHA tamamlandı:', digits.join(''));
        }
      });

      loginButton2.addEventListener("click", () => {
        const user = username2.value.trim();
        const pass = password2.value.trim();

        if (!user || !pass) {
          showStatus(status2, "Lütfen tüm alanları doldurun.", "error");
          return;
        }

        if (!captcha2.isCompleted()) {
          showStatus(status2, "Lütfen CAPTCHA doğrulamasını tamamlayın.", "error");
          return;
        }

        if (user === "user" && pass === "password123") {
          showStatus(status2, "✓ Başarıyla giriş yaptınız!", "success");

          setTimeout(() => {
            username2.value = "";
            password2.value = "";
            captcha2.reset();
            loginButton2.disabled = true;
            status2.classList.remove("show");
          }, 2000);
        } else {
          showStatus(status2, "✗ Kullanıcı adı veya şifre hatalı!", "error");
          captcha2.reset();
          loginButton2.disabled = true;
        }
      });

      function showStatus(element, message, type) {
        element.textContent = message;
        element.className = `status-indicator show ${type}`;
      }
    });
  </script>
</body>
</html>
